#!/usr/bin/env bash
set -euo pipefail
echo "== pre-push: security & quality gates =="
ROOT_DIR="$(git rev-parse --show-toplevel)"
WEB_DIR="$ROOT_DIR/apps/web"

# Fast smoke (skip on CI if needed)
if command -v node >/dev/null 2>&1; then
  if [ -f "$ROOT_DIR/package.json" ]; then
    (cd "$ROOT_DIR" && npm run -s typecheck || true)
    (cd "$ROOT_DIR" && npm run -s lint || true)
  fi
fi

echo "== pre-push: checking for tracked Terraform plan files =="
TP=$(git ls-files --cached | grep -E '(^|/)(tfplan(_[A-Za-z0-9._-]+)?|.*\.tfplan)$' || true)
if [ -n "$TP" ]; then
  echo "Error: Terraform plan files are tracked and must not be committed:" >&2
  echo "$TP" >&2
  echo "Run: git rm --cached <file>  (plans should be ignored)" >&2
  exit 1
fi

# Security scans (read-only; fail on findings)
if command -v gitleaks >/dev/null 2>&1; then
  (cd "$WEB_DIR" && gitleaks detect --no-git --config "$ROOT_DIR/.gitleaks.toml" --exit-code 1)
fi
if command -v osv-scanner >/dev/null 2>&1; then
  (cd "$WEB_DIR" && osv-scanner -r .)
fi
if command -v semgrep >/dev/null 2>&1; then
  (cd "$WEB_DIR" && semgrep --config auto --error --exclude lib/backend --exclude scripts)
fi
if command -v trivy >/dev/null 2>&1; then
  trivy fs --exit-code 1 --severity HIGH,CRITICAL "$WEB_DIR"
fi
echo "== pre-push: PASS =="
