EarlyBird — Final Roadmap (Low‑Latency Revision)
Date: 2025-09-13

Goal: sub‑700 ms mouth‑to‑ear on live calls, reliable and scalable.

Latency Plan (Budget Targets)
- Twilio PSTN → Media WS connect: 60–120 ms (regional)
- Media decode + forward (per frame): 10–20 ms
- ElevenLabs realtime (ASR+TTS partials): 250–450 ms
- Return to Twilio + playout: 50–120 ms
- Total target: 370–710 ms (p95 under 700 ms with regional placement)

One‑Line Flow (top → bottom; final single path)
Twilio (PSTN, Media Streams WS, signed webhooks) — ✅ 90%
↓
Vercel Web: POST /api/voice/incoming → TwiML <Connect><Stream url="${MEDIA_WSS_URL}"/> — ✅ 90%
↓
AWS Media Server (WS: /rtm/voice, keepalive, backpressure) — 🟡 40%
↓
ElevenLabs Realtime Agent (full‑duplex ASR/TTS, barge‑in) — 🟡 60%
↓
AWS Media Server (relay TTS frames back to Twilio) — 🟡 40%
↓
Post‑Call: finalize transcript + summaries (enqueue) — 🟡 60%
↓
Rumble Cloud (recordings via presigned URLs) — ✅ 80%
↓
Upstash Redis (rate limit, light session state; off hot path) — ✅ 90%
↓
Stripe Billing (webhooks, portal, usage) — ✅ 70%
↓
Dashboard (Auth, Billing, Calls + Transcripts) — 🟡 50%

Control Plane (keep on Vercel)
- Twilio webhooks (voice/incoming, voice/status) — signed; Node runtime + force‑dynamic
- ElevenLabs webhooks (personalization, post‑call) — HMAC (t+v0); 403 on fail
- Stripe webhook: /api/webhooks/stripe; raw body verify; PHI metadata guard
- Storage presign: /api/storage/presign (x‑smoke‑key); short TTL

What to Remove / Avoid
- Railway + Deepgram (legacy) — ❌ not used
- Extra proxies in audio path — Media should talk directly to ElevenLabs WS
- CORS for app→API — use Edge upstream proxy only if browser must call the API

Region & Networking
- Place media in an AWS region/AZ closest to expected callers and ElevenLabs PoP (measure RTT)
- Keep 1 machine warm: `min_machines_running = 1`, avoid cold starts
- Use appropriate EC2 instance class for predictable latency (e.g., c7i/c6in)
- Terminate TLS on ALB; no CDN in front of WS

Codec & Framing
- Twilio sends 8 kHz mu‑law (20 ms frames). Decode asap; only resample if ElevenLabs requires 16 kHz
- Keep buffer small (<60 ms). Drop frames if `ws.bufferedAmount > 1MB` (already guarded)
- Send TTS audio back as soon as first chunks arrive (streaming), not after full sentence

Server Tuning (Media)
- Node 20, single process per VM (or cluster=1). Prefer low GC pauses (short‑lived buffers)
- Keepalive pings every 15s; close on backpressure or auth failure
- Optional WS auth: header `x-media-auth: ${MEDIA_AUTH_TOKEN}`

Observability
- Minimal, PHI‑free logs: start/stop, frames/s, queue depth, RTT to ElevenLabs
- Metrics: p50/p95 round‑trip to ElevenLabs; reconnection count; Twilio WS close codes

Env & Config
- Vercel: `MEDIA_WSS_URL`, `NEXT_PUBLIC_SITE_URL`, (`API_UPSTREAM` only if using upstream proxy)
- Media (AWS): `PORT`, `WS_PATH=/rtm/voice`, `MEDIA_AUTH_TOKEN` (optional), `ELEVENLABS_API_KEY`, `ELEVENLABS_AGENT_ID`
- Storage: `AWS_*`/`S3_*` for Rumble; short `S3_SIGNED_URL_EXPIRES`

Action Checklist
1) Media (AWS) — 🟡 40%
   - Wire ElevenLabs realtime WS in apps/media/server.mjs (bridge mulaw↔PCM as required)
   - Set `min_machines_running=1`, dedicated CPU; deploy and set DNS `media.oneearlybird.ai`
2) Vercel — ✅/🟡
   - Ensure envs set; keep single upstream Edge route only if browser needs to call API directly
3) Dashboard — 🟡 50%
   - Calls view (from DB + Rumble keys); Transcripts view; Stripe portal
4) Smokes — 🟡
   - Live call latency test (measure mouth‑to‑ear); Stripe signed events; rate‑limit 200→429

Mandatory Coding Practices (Security & Guardrails)
1) Headers & Edge Security
- Single source headers in `apps/web/middleware.ts` only.
- Content-Security-Policy: per-request nonce; no `unsafe-inline`/`unsafe-eval`.
- Strict-Transport-Security: `max-age=63072000; includeSubDomains; preload`.
- Cross-Origin-Opener-Policy: `same-origin`; Cross-Origin-Embedder-Policy: `require-corp`.
- Permissions-Policy: deny geolocation, camera, microphone, payment, usb, xr, pip, etc.
- X-Content-Type-Options: `nosniff`; Referrer-Policy: `strict-origin-when-cross-origin`.
- Next config: `poweredByHeader: false`; no duplicate header setting elsewhere.

2) No Inline or Dangerous Code
- No inline `<script>` tags; all scripts/styles must be nonce’d.
- Never use `eval`, `new Function`, or dynamic import of untrusted URLs.
- Avoid `dangerouslySetInnerHTML`; if unavoidable, sanitize and gate behind nonce.

3) Webhook Security (Node runtime + force-dynamic)
- Twilio `/api/voice/incoming` and `/api/voice/status`: validate `X-Twilio-Signature` with official SDK.
  - Support JSON body (`validateRequestWithBody`) and URL-encoded (`validateRequest`).
  - Derive full external URL from `NEXT_PUBLIC_SITE_URL`. On failure return 403.
- Stripe `/api/webhooks/stripe`: read raw body; verify with `constructEvent`; 400/403 on failure.
  - PHI/PII guard on metadata; minimal logs; no sensitive fields.
- ElevenLabs `/api/elevenlabs/*`: HMAC (t + v0) with time-skew tolerance; 403 on failure.
- All sensitive endpoints: `export const runtime = 'nodejs'`; `export const dynamic = 'force-dynamic'` as needed; `cache-control: no-store`.

4) Storage & Object Security (Rumble/S3)
- Server-only AWS SDK v3 module; never import client-side.
- Presigned URLs only; short TTL (`S3_SIGNED_URL_EXPIRES`).
- Auth for presign endpoint via `x-smoke-key`; deny-by-default.
- Enforce key template and validation (no traversal, strict charset, env/date checks).
- Support path-style + custom endpoint for Rumble; never expose credentials to client.

5) Rate Limiting & Caching
- Upstash Redis REST for limiter; smoke must show 200→429 with Retry-After.
- No wildcard `*` CORS; sensitive routes return `cache-control: no-store`.

6) Upstream Proxy (Optional)
- Keep only Edge version at `/api/upstream/[...path]` if browser must call API directly.
- Strip hop-by-hop headers; do not forward cookies unless required.
- Restrict to allowlist if feasible; log minimally; apply edge rate limits.

7) Secrets & Environment
- Track only `*.example` env files; ignore `.env*` locals. Rotate any leaked tokens.
- Use Vercel envs for prod/preview; avoid printing secrets in logs.
- Client-visible only via `NEXT_PUBLIC_*`.

8) Input Validation & Limits
- Deny-by-default tooling routes; strict JSON schema, content-type checks, and size limits.
- Enforce method allowlists; return explicit 4xx for invalid inputs.

9) Logging & PHI Hygiene
- No PHI/PII in logs; redact tokens and IDs. Use minimal structured logs.
- No stack traces in production responses; consistent error shapes.

10) Smokes & Monitoring
- Headers probe on `/` for CSP/HSTS/COOP/COEP/PP.
- Unsigned webhook smokes: Twilio→403, Stripe→400/403, ElevenLabs→403.
- Limiter smoke: 200→429→200 (cooldown).
- Media smoke: WS health (`/`), ping→pong on `/rtm/voice`.

11) Process: Anti-Drift & SVP Discipline
- Anti-Drift gate at top of changes/PRs; reference guardrails.
- Small, verifiable patches: ≤2 files or ≤120 LOC per change unless migration.
- Precommit: lint, typecheck, format; CI audit for vulnerabilities.
