EarlyBird — Three One-Line Verticals (Caller • Business Owner • Builder)
=====================================================================

Purpose
-------
You asked for three clean, separate, end‑to‑end “one-line vertical” diagrams—each with precise routing and the highest‑quality, near‑zero‑latency integration choices. These flows are intentionally concise yet descriptive, listing what you must integrate at each step.

=====================================================================
Routing Completion (Caller Flow):
- Telephony Voice Ops: ❌ 1/5 (20%)
- Transcript Finalize: ✅ 1/1 (100%)
- Tools: ✅ 4/4 (100%)
- Rate-limit Smoke: ✅ 1/1 (100%)

=====================================================================

Caller (PSTN or WebRTC)
  │
  ├─→ Preferred Ingress (choose path)
  │     ├─ PSTN (Public phone #) → Carrier forward or Port to EarlyBird Provider
  │     │       Preferred: Twilio Programmable Voice (Media Streams + SIP)  [low friction, global]
  │     │
  │     └─ WebRTC Click‑to‑Call widget on client site/app  [HD 16–24 kHz; lowest perceived latency]
  │             Preferred: Native WebRTC to EarlyBird edge (no extra vendor), optional Vonage if needed
  │
  ├─→ EarlyBird Voice Bootstrap (Webhook)
  │     └─ /api/voice/incoming → returns <Connect><Stream> (Twilio) OR upgrades WebRTC directly to WS/RTP — ✅ 100%
  │
  ├─→ Real‑Time Audio Stream ↔ EarlyBird Media Orchestrator (wss://oneearlybird.ai/rtm/voice)
  │     ├─ Ingress: frame chunking 10–20 ms + VAD (server‑side barge‑in <70 ms)
  │     ├─ Streaming ASR (partials <150 ms):
  │     │       Preferred: Deepgram Nova/Aura or Google Cloud STT v2 (telephony + wideband tuned)
  │     ├─ Micro‑Policy Model (5–30 ms): end‑of‑turn?, tool or talk?, safety
  │     │       Preferred: small distilled 3–8B (local, quantized) with KV cache (GPU on edge)
  │     ├─ Response LLM (first token 80–120 ms; streaming):
  │     │       Preferred: Realtime LLM (speech I/O) OR fast 70B‑class with function‑calling
  │     │       Tools exposed: book_meeting, transfer_to_owner, create_lead, kb_search, hours_check
  │     ├─ Streaming TTS (first audio 90–150 ms; chunk 150–220 ms; narrowband/wideband aware):
  │     │       Preferred: ElevenLabs (primary), MS Neural TTS (backup), Google Wavenet/Studio (backup)
  │     ├─ Latency masking & naturalness: pre‑buffered backchannels (“sure”, “okay”) only when needed
  │     └─ Barge‑in: mute TTS immediately on VAD detect; resume after caller pause
  │
  ├─→ Business Logic & Integrations (deterministic + tool calls <150–250 ms)
  │     ├─ Booking/Calendars: Google Calendar (primary), Microsoft 365/Outlook (co‑primary), Calendly as connector
  │     ├─ CRM: HubSpot (SMB default), Salesforce (enterprise), optional Pipedrive/Zoho
  │     ├─ Knowledge Base: pgvector in Postgres (primary) OR Pinecone/Qdrant at scale; nightly refresh
  │     ├─ Address/Time/Geo: Google Maps Timezone + geocoding (optional)
  │     └─ Transfer/Handoff: deterministic keywords + policy model; warm transfer to owner/hunt group
  │
  ├─→ Optional Transfer to Owner/Team
  │     └─ /api/voice/transfer → /api/voice/dial (TwiML <Dial> owner) → fallback to AI or voicemail if no‑answer — ❌ 0%
  │
  ├─→ Call Completion (Provider Status & Recording)
  │     ├─ /api/voice/status (queued/answered/completed) — ❌ 0%
  │     ├─ /api/voice/recording (provider posts recording URL; store to S3; CloudFront for playback) — ❌ 0%
  │     └─ /api/transcript/finalize (diarize + redact PII; store to transcripts table) — ✅ 100%
  │
  └─→ Post‑Call Fanout (≤1 s from hangup)
        ├─ Usage metering → Stripe Usage Records (minutes/tokens)
        ├─ Outbound webhook (signed HMAC) to client CRM/helpdesk as configured
        └─ Dashboard updates (live activity → finalized record with transcript + recording)

Targets: mouth‑to‑ear ≤ 500–700 ms; ASR partials <150 ms; policy <30 ms; first‑token <120 ms; TTS start <150 ms.


============================================================================
Routing Completion (Business Owner Flow):
- Health/Manifest: ✅ 2/2 (100%)
- Usage Summary: ✅ 1/1 (100%)
- Billing (Stripe): ✅❌ 2/3 (67%)
- OAuth Start: ❌ 0/1 (0%)
- Numbers (buy/webhook): ❌ 0/2 (0%)
- Agent Tool: ❌ 0/1 (0%)
- Knowledge Base: ❌ 0/2 (0%)

============================================================================

Visitor → EarlyBird Signup (Auth)
  │
  ├─→ Billing Setup
  │     └─ Stripe Customer + Subscription (base plan) + Metered add‑on (voice minutes and/or LLM tokens)
  │
  ├─→ Number Connection (keep public number)
  │     ├─ Option A (fastest): Carrier conditional/all‑call forward → EarlyBird DID (Twilio)
  │     ├─ Option B (control): Port public number → Twilio (you manage routing)
  │     └─ Option C (PBX): Client SIP trunk → EarlyBird SIP URI (Teams/Zoom Phone/PBX)
  │
  ├─→ Agent Configuration
  │     ├─ Brand voice + tone; guardrails; compliance phrases (recording consent by locale)
  │     ├─ Business hours; transfer rules (owner availability, DND windows)
  │     ├─ Knowledge Base upload/sync (PDFs, URLs) → embeddings → pgvector
  │     └─ Integrations connect:
  │           • Calendars: Google (primary), Microsoft 365/Outlook (primary)
  │           • CRM: HubSpot (SMB), Salesforce (enterprise)
  │           • Optional: Calendly, Slack notifications, Helpdesk (Zendesk/Freshdesk) webhooks
  │
  ├─→ Go‑Live Health Check
  │     ├─ Test call wizard (PSTN & WebRTC), latency waterfall (ASR/LLM/TTS timings)
  │     └─ Number routing verification (Twilio webhook set to /api/voice/incoming, 200 OK) — ✅ 100%
  │
  ├─→ Operate (Dashboard)
  │     ├─ Activity: live calls, barge‑in rate, first‑token time, average response length
  │     ├─ Calls: transcripts (streamed → finalized), recordings, tags, lead creation
  │     ├─ Scheduling: availability, buffers, locations (Phone/Zoom/Meet)
  │     ├─ Integrations: OAuth status, field mapping (lead/contact pipeline)
  │     ├─ Billing: invoices, usage, customer portal (Stripe)
  │     └─ Settings: team roles, API keys, outbound webhooks (HMAC‑signed)
  │
  └─→ Outcomes
        ├─ Bookings on their calendar (Google/Microsoft) with attendee details
        ├─ Leads/contacts created in CRM with call summary + link to recording
        └─ Notifications via email/SMS/Slack (optional)

Defaults: safest enterprise‑friendly stack (Stripe, Twilio, Google/Microsoft, HubSpot/Salesforce) with minimal clicks.


==================================================================================
C) BUILDER FLOW — “What I must build and integrate in EarlyBird to make it work”
==================================================================================

Builder (You) → EarlyBird Platform Work
  │
  ├─→ Core Services (Edge‑co‑located for latency)
  │     ├─ Media Orchestrator (WS/RTP): /rtm/voice — handles frames, VAD, barge‑in
  │     ├─ ASR service (streaming): Deepgram or Google STT v2 clients with partials
  │     ├─ Policy micro‑model runner (local 3–8B) — stop/continue/tool/safety in 5–30 ms
  │     ├─ LLM Orchestrator (function‑calling + streaming)
  │     ├─ TTS streamer (ElevenLabs primary; Azure/Google as backups) — sentence‑internal yields
  │     └─ Tool router (≤150–250 ms): book_meeting, transfer_to_owner, create_lead, kb_search, hours_check
  │
  ├─→ Web/API (Next.js 14, App Router)
  │     ├─ /api/auth/* (signup/login/MFA), /api/billing/portal (Stripe) — ✅ 100%
  │     ├─ /api/numbers/buy, /api/numbers/webhook (set Twilio webhook) — ❌ 0%
  │     ├─ /api/voice/incoming (Twilio signature verify → <Connect><Stream>) — ✅ 100%
  │     ├─ /api/voice/status (call lifecycle), /api/voice/recording (URL ready) — ❌ 0%
  │     ├─ /api/voice/transfer (update call to owner), /api/voice/dial (TwiML <Dial> owner) — ❌ 0%
  │     ├─ /api/transcript/finalize (diarization, redaction) — ✅ 100%
  │     ├─ /api/integrations/oauth/start|callback (Google/Microsoft/HubSpot/Salesforce) — ❌ 0%
  │     ├─ /api/agent/tool (LLM tool webhooks), /api/kb/doc, /api/kb/search — ❌ 0%
  │     └─ /api/stripe/webhook, /api/stripe/usage (metered) — ❌ 0%
  │
  ├─→ Data (Postgres + S3)
  │     ├─ Tables: accounts, users, subscriptions, numbers, calls, call_legs, recordings,
  │     │          transcripts, integrations, bookings, leads, usage_reports, webhooks
  │     ├─ Vector: pgvector for embeddings (primary), optional Pinecone/Qdrant for scale
  │     └─ Storage: S3 for recordings/transcripts; CloudFront CDN for dashboard playback
  │
  ├─→ Dashboard (Multi‑tenant UX)
  │     ├─ Activity: live presence + latency waterfall (ingress→ASR→policy→LLM→TTS)
  │     ├─ Calls detail: transcript stream → finalized, inline recording player, actions
  │     ├─ Numbers: assign DIDs, routing health, transfer/handoff rules, business hours
  │     ├─ Integrations: OAuth connect, field mappings, test push
  │     ├─ Scheduling: availability editor, buffers, booking destinations
  │     └─ Billing: plan, usage charts, invoices, portal
  │
  ├─→ Latency Engineering
  │     ├─ Co‑locate ASR/Policy/LLM/TTS in same edge region as telephony ingress
  │     ├─ Keep warm pools (N sessions) for ASR/LLM/TTS; speculative decoding for first token
  │     ├─ Short replies first; continue if silence; backchannels when LLM startup >120 ms
  │     ├─ Barge‑in stop <70 ms; mute TTS on VAD; restart stream cleanly
  │     └─ Tool calls cached; SLA 150–250 ms; timeouts + fallback lines
  │
  ├─→ Security & Compliance
  │     ├─ Webhook signature validation (Twilio/X‑Signature); HMAC on outbound webhooks
  │     ├─ Short‑lived WS tokens per call (scope: account_id + call_sid)
  │     ├─ PII redaction in transcripts; KMS encryption at rest; principle of least privilege
  │     ├─ Recording consent prompts per jurisdiction; configurable per number
  │     └─ Row‑level security: every query filtered by account_id
  │
  └─→ Preferred Vendors (2025 “safe defaults”)
        • Telephony: Twilio Programmable Voice (Media Streams, SIP, <Dial>)
        • ASR: Deepgram Nova/Aura (primary), Google STT v2 (backup)
        • LLM: Realtime LLM (speech I/O) OR fast 70B‑class with function‑calling
        • TTS: ElevenLabs streaming (primary), Azure Neural TTS / Google Wavenet as backups
        • Calendars: Google, Microsoft 365/Outlook (co‑primary)
        • CRM: HubSpot (SMB), Salesforce (enterprise), Pipedrive/Zoho optional
        • Payments: Stripe Billing + Usage Records
        • Vector/KM: Postgres + pgvector (primary), Pinecone/Qdrant optional
        • Storage/CDN: S3 + CloudFront
        • Observability: OpenTelemetry traces for latency waterfall; logs to CloudWatch/Datadog

Final Notes
-----------
• Aim for mouth‑to‑ear ≤ 500–700 ms across both PSTN and WebRTC; prefer WebRTC for HD realism.
• Keep conversations incremental: 1–2 sentence replies, continuous streaming everywhere.
• Deterministic transfer rules first; policy model second; always provide a fast human handoff path.

Routing Completion Summary (as of 2025-09-09 19:00:14 UTC)
--------------------------------------
- Core Health/Manifest: ✅ 2/2 (100%)
- Usage Summary: ✅ 1/1 (100%)
- Telephony Voice Ops (transfer/dial/recording/status): ❌ 1/5 (20%)
- Transcript Finalize: ✅ 1/1 (100%)
- Tools (book_meeting/transfer_to_owner/create_lead/hours_check): ✅ 4/4 (100%)
- Knowledge Base (kb/search, kb/doc): ❌ 0/2 (0%)
- Billing (Stripe) (webhook, billing portal, usage): ✅❌ 2/3 (67%)
- OAuth Start: ❌ 0/1 (0%)
- Numbers (buy/webhook): ❌ 0/2 (0%)
- Agent Tool: ❌ 0/1 (0%)
- Rate-limit Smoke: ✅ 1/1 (100%)

Overall One-Line Routing Completion: ✅❌ 14/23 (≈61%)
Notes:
- “✅” = implemented and live; “❌” = not yet implemented.
- Billing portal present as stub/minimal; Stripe usage endpoint pending.
- Rate-limit shows 200 → 429 on configured deployments; degrades to disabled when Upstash envs absent.
